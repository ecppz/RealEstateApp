@using Domain.Common.Enums
@model List<OfferViewModel>
@{
    Layout = "_LayoutAgent";
}

<div class="container mt-8">
    <h2><i class="bi bi-cash-stack me-2"></i> Ofertas del Cliente</h2>
    <hr />

    <!-- Botón para volver atrás -->
    <div class="mt-3 text-left">
        <a asp-controller="Offer" asp-action="PropertyDetailAgent" asp-route-propertyId="@Model.FirstOrDefault()?.PropertyId"
           class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Volver al detalle de la propiedad
        </a>
    </div>

    <hr />

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">
            No hay ofertas registradas para este cliente en esta propiedad.
        </div>
    }
    else
    {
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Propiedad</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var offer in Model)
                {
                    <tr>
                        <td>@offer.PropertyId</td>
                        <td>@offer.Amount.ToString("C")</td>
                        <td>@offer.Date.ToString("g")</td>
                        <td>@offer.Status</td>
                        <td>
                            @if (offer.Status == OfferStatus.Pending)
                            {
                                <div class="d-flex gap-2">
                                    <form asp-action="Accept" method="post" class="confirm-action" data-action="aceptar">
                                        <input type="hidden" name="offerId" value="@offer.Id" />
                                        <input type="hidden" name="propertyId" value="@offer.PropertyId" />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-check-circle"></i> Aceptar
                                        </button>
                                    </form>

                                    <form asp-action="Reject" method="post" class="confirm-action" data-action="rechazar">
                                        <input type="hidden" name="offerId" value="@offer.Id" />
                                        <input type="hidden" name="propertyId" value="@offer.PropertyId" />
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="bi bi-x-circle"></i> Rechazar
                                        </button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">No disponible</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@section Scripts {
    <script>
        document.querySelectorAll(".confirm-action").forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                let action = form.getAttribute("data-action");
                Swal.fire({
                    title: "¿Estás seguro?",
                    text: "¿Deseas " + action + " esta oferta?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#198754",
                    cancelButtonColor: "#dc3545",
                    confirmButtonText: "Sí, " + action,
                    cancelButtonText: "Cancelar"
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });
    </script>
}